import os,sys,re,hashlib,heapq

#define user info function
def UserInfo():
    print('---------------------------- Macro checker -------------------------------')
    print('required 3 arguments: <olevba log/macro file> <hashes file> <type of work>')
    print('')
    print('Where:')
    print('1) types of work:')
    print('                 -c check file')
    print('                 -a appdate hash file')
    print('--------------------------------------------------------------------------')

#define types of work
workType = ['-c','-a']

#check argv sequence
if len(sys.argv) != 4:
    UserInfo()
    exit()
else:
    if (os.path.isfile(sys.argv[1]) and os.path.isfile(sys.argv[2])) and (sys.argv[3] in workType) == False:
        UserInfo()
        exit()

#open log file for reading
olevbaLog = open(sys.argv[1],'r')

#open hashes file for reading
md5Hashes = open(sys.argv[2],'r')

#type of work:
work = sys.argv[3]

#read olevba log lines 
_olevbaLog = ['']
for line in olevbaLog: 
    if line != '\n':
        _olevbaLog.append(line)

#close olevba log
olevbaLog.close()

#compile regexp for Functions and Subs 
regex  = re.compile('((F|f)(U|u)(N|n)(C|c)(T|t)(I|i)(O|o)(N|n)(\x20)+([\u0041-\u007A\u0410-\u044F])+(\x20)*\(([\u0041-\u007A\u0410-\u044F\x20\x27,_="])*\)[\u0041-\u007A\u0410-\u044F\x20\x27,;_="\s]*(E|e)(N|n)(D|d)(\x20)+(F|f)(U|u)(N|n)(C|c)(T|t)(I|i)(O|o)(N|n))|((S|s)(U|u)(B|b))(\x20)+([\u0041-\u007A\u0410-\u044F])+(\x20)*\(([\u0041-\u007A\u0410-\u044F\x20\x27,_="])*\)[\u0041-\u007A\u0410-\u044F\x20\x27,;_="\s]*(E|e)(N|n)(D|d)(\x20)+((S|s)(U|u)(B|b))')
 
#find all matches in olevba log lines
matches = regex.finditer(''.join(_olevbaLog))

#clear olevba log lines
_olevbaLog.clear()

#read md5 hashes file
checkList = [line[:-1] for line in md5Hashes]

#close md5 hashes file
md5Hashes.close()

#processing "matches" step by step; in each step forming result
result = ''

#work -c (check macro)
if work == '-c':
    state = ["clean","malicus"]

    for match in matches:
        #get result from match
        result = match.group()

        #calculate md5 hash
        _hash  = hashlib.md5(result.encode('utf-8')).hexdigest()
        
        #print result
        if _hash in checkList:
            print("------------------------ " + state[0] + " ------------------------")
        else:
            print("----------------------- " + state[1] + " -----------------------")
        
        print (result)
        print("---------- "+ _hash + " -----------")
        print("")
        
#work -a (add macro) 
if work == '-a':
    state = ["skipped","added"]
    md5Hashes = open(sys.argv[2],'w')
    for match in matches:
        #get result from match
        result = match.group()

        #calculate md5 hash
        _hash  = hashlib.md5(result.encode('utf-8')).hexdigest()
        
        #print result
        if _hash in checkList:
            print("------------------------ " + state[0] + " ------------------------")
        else:
            print("----------------------- " + state[1] + " -----------------------")
            checkList.append(_hash)
        
        print (result)
        print("---------- "+ _hash + " -----------")
        print("")

    #update md5 hashes
    checkList = [line + "\n" for line in checkList]
    md5Hashes.writelines(checkList)

#clean up
md5Hashes.close()
matches   = None
result    = None
checkList = None
